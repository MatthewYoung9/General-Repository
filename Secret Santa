# Allocates players for secret santa and send them an email with their allocation. Entirely anonymous allocation, even to programmer (unless code is adjusted, of course)

import csv, smtplib, ssl
from random import randint, shuffle

def random_derangement(n):
    while True:
        v = [i for i in range(n)]
        for j in range(n - 1, -1, -1):
            p = randint(0, j)
            if v[p] == j:
                break
            else:
                v[j], v[p] = v[p], v[j]
        else:
            if v[0] != 0:
                return tuple(v)

players = ["Adrian","Barbara", "Claire", "Dennis"]
emails = ["brian@example.com", "barbara@example.com", "claire@example.com", "dennis@example.com"]
shuffling = random_derangement(len(players))
matchings = [players[shuffling[i]] for i in range(len(players))]

message = """Subject: Secret Santa

Hi {name}, you have been allocated {matching}"""
from_address = "secretsanta@example.com"
password = "example_password"

context = ssl.create_default_context()
with smtplib.SMTP_SSL("smtp.gmail.com", 465, context=context) as server:
    server.login(from_address, password)
    for player, email, matching in zip(players, emails, matchings):
        server.sendmail(
            from_address,
            email,
            message.format(name=player,matching=matching),
            )
